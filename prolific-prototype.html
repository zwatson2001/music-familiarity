<!DOCTYPE html>
<html>
  <head>
    <title>Prolific prototype </title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>

    var jsPsych = initJsPsych({
        on_finish: function() {
            jsPsych.data.displayData().filter({type: 'jsPsychHtmlKeyboardResponse'});
        } 
    });
    
    var timeline = [];

    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `Welcome to the study! You will hear a series of pre-recorded melodies. 
      After each melody, you will be asked if you think you have heard it before. Please answer either yes or no by pressing the 
      'y' or the 'n' key on the keyboard. You should answer yes if the melody sounds familiar to you, even if you cannot 
      remember what it is called or where it is from. Press any key to begin.`, 
      data: {
        experiment_type: 'test'
      }
    };

    var playAudio = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: jsPsych.timelineVariable('track'),
        choices: "NO_KEYS",
        prompt: "<div style='font-size:60px;'>+</div>",
        post_trial_gap: 1000,
        trial_ends_after_audio: true, 
        data: {
            task: 'audio'
        }
    }

    /* define question trial */
    var question = {
        type: jsPsychHtmlKeyboardResponse, 
        stimulus: `Have you heard this melody before? Press 'y' for yes or 'n' for no.`, 
        choices: ['y', 'n'], 
        post_trial_gap: 2000, 
        data: {
            task: 'question'
        }
    }

    var audioResponseTimeline = {
        timeline: [playAudio, question],
        timeline_variables: [
            {track: 'prolific_audio_files/mario_unaltered.mp3', track_id: 'mario'},
            {track: 'prolific_audio_files/bach_minuet_unaltered.mp3', track_id: 'bach_minuet'}, 
            {track: 'prolific_audio_files/blue_danube_unaltered.mp3', track_id: 'blue_danube'},
            {track: 'prolific_audio_files/brahms_lullaby_unaltered.mp3', track_id: 'brahms_lullaby'},
            {track: 'prolific_audio_files/entertainer_unaltered.mp3', track_id: 'entertainer'},
        ],
        data: {
            track_id: jsPsych.timelineVariable('track_id')
        }
    }

    var end_message = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `This is the end of the study. 
        Thank you for participating! Press any key to finish.`
    }; 

    /* generate unique filename */
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;
            
    /* send data to OSF */
   const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "EhlkOUVAPFEt",
        filename: filename,
        data_string: ()=>jsPsych.data.get().filter({task: 'question'}).csv()
    }; 

    /* build timeline */
    timeline.push(welcome);
    timeline.push(audioResponseTimeline)
    timeline.push(end_message);  
    timeline.push(save_data); 

    jsPsych.run(timeline); 

  </script>
</html>
